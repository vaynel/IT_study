# KR만 허용하기 
## 개요 
- nginx 로그를 통해서 비정상적인 접속시도 확인 
- whois에서 해외 IP로 확인됨 
- 서버 보안을 위해 Country가 KR인 것만 허용 및 Github Webhook허용

## 차단 적용 방법
### 사용 기술 
- 화이트리스트 방식  
- Nginx
- GeoIP  
### 적용 방법
#### 1.필수 패키지 설치 
```
# 패키지 업데이트
sudo apt update

# libmaxminddb 및 Nginx GeoIP2 모듈 설치
sudo apt install libmaxminddb0 libmaxminddb-dev mmdb-bin libnginx-mod-http-geoip2 -y
```

#### 2.GeoIP2 데이터베이스 준비
1. 계정 생성 : MaxMind 홈페이지
2. 파일 업로드 : 다운로드한 GeoLite2-Country.mmdb 파일을 서버의 /usr/share/GeoIP/ 폴더에 업로드합니다.
  (폴더가 없으면 생성: sudo mkdir -p /usr/share/GeoIP)
3. 체크  
```
# mmdblookup 명령어로 IP 정보 조회 테스트
mmdblookup --file /usr/share/GeoIP/GeoLite2-Country.mmdb --ip 8.8.8.8 country iso_code
```

#### 3. Nginx 메인 설정
1. 공통 맵핑 로직 생성 
```
sudo vi /etc/nginx/nginx.conf

# 하기 내용 작성 추가
http {
    # 1. GeoIP2 모듈 로드 및 DB 경로 지정
    geoip2 /usr/share/GeoIP/GeoLite2-Country.mmdb {
        auto_reload 5m;
        $geoip2_data_country_code default=XX source=$remote_addr country iso_code;
    }

    # 2. 국가 코드에 따른 허용 여부 매핑 (화이트리스트 방식)
    map $geoip2_data_country_code $is_allowed_country {
        default no;  # 기본값: 모두 차단
        KR      yes; # 한국: 허용
    }

    # ... 기존 설정 ...
}
```

4. 개별 사이트 적용 및 Webhook 예외 처리 

```
sudo vi /etc/nginx/sites-available/blog
```

```
server {
    listen 443 ssl;
    server_name blog.log2u.me;

    # [중요] 일반적인 접근은 한국만 허용
    location / {
        if ($is_allowed_country = no) {
            return 403; # 한국 외 IP는 403 Forbidden
        }
        proxy_pass http://localhost:8080; # Quartz 서비스
    }

    # [중요] GitHub Webhook은 국가 제한 없이 허용
    location /webhook {
        # 이 경로에는 국가 체크 로직을 넣지 않습니다.
        proxy_pass http://localhost:5000/webhook;
        
        # Webhook Secret 검증을 위한 헤더 전달 (이전에 설정한 내용)
        proxy_set_header X-Hub-Signature-256 $http_x_hub_signature_256;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

5. Nginx 재시작 
```
# 구문 에러 확인
sudo nginx -t

# 서비스 재시작
sudo systemctl restart nginx
```


6. Snippents 작성후 차단하기 
```
sudo vi /etc/nginx/snippets/geoip-filter.conf

server {
    listen 80;
    server_name protect.example.com;

    # 이 한 줄로 해당 도메인은 해외 IP 전면 차단
    include snippets/geoip-filter.conf;

    location / {
        proxy_pass http://localhost:3000;
    }
}

```

사용 예시 
```
server {
    listen 80;
    server_name protect.example.com;

    # 이 한 줄로 해당 도메인은 해외 IP 전면 차단
    include snippets/geoip-filter.conf;

    location / {
        proxy_pass http://localhost:3000;
    }
}
```
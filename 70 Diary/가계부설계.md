# 프로젝트 제목

홈 재무 자동화 & 소비 습관 분석 시스템 (2축 분류 기반)

---

## 개요

이 프로젝트는 **카드 결제/이체 등 소비 이벤트를 자동 수집**하여, 홈서버에서 **가계부 원장(ledger)**을 안정적으로 운영하고 동시에 **소비 습관/재무 상태를 다차원으로 분석**하기 위한 시스템이다.

핵심 설계 목표는 아래 3가지다.

1. **가계부(정확한 원장)와 재무관리(분석/습관 파악)를 분리**

   * 원장은 “확정된 데이터만” 기록하여 신뢰성을 높인다.
   * 분석은 별도 레이어에서 자유롭게 확장한다.

2. **2축(다차원) 분류를 1급 시민으로 지원**

   * 축 A(지출 성격 / What): 식료품, 교통, 외식, 카페, 통신 등
   * 축 B(사용처/목적 / Why/Where): 교회, 개인, 가족, 업무, 모임 등
     예: `식료품 / 교회`, `식료품 / 개인`

3. **자동 분류 + 웹 검수(재분류) UX로 운영 효율 극대화**

   * 자동 분류는 추천과 확률(confidence)을 제공한다.
   * 사용자는 웹에서 빠르게 확정/수정한다.
   * 확정된 거래만 원장에 반영된다.

### 기대 효과

* “내 돈이 어디로 가는지”를 **항상 최신 상태로** 확인
* “소비 습관”을 **카테고리×목적(교차축)**으로 분석
* 예산 초과/이상 지출 등을 자동 감지하여 알림 및 리포트화

---

## 아키텍처

### 1) 논리 아키텍처 (계층 구조)

```
[수집 계층]
  - 결제 SMS, 수동 입력, CSV/내역 파일, 기타 이벤트
        |
        v
[수집 API + 이벤트 큐]
  - 중복 방지, 재시도, 장애 격리, 순서 보장(선택)
        |
        v
[정규화/표준화 계층]
  - 가맹점 정규화(merchant normalization)
  - 시간/통화/결제수단 정규화
  - 계정(자산/카드) 매핑
        |
        v
[분류 엔진 (2축)]
  - 축 A: 지출 성격(What)
  - 축 B: 사용처/목적(Why/Where)
  - 추천 top-N + confidence score
        |
        v
[검수/분류 웹 UI]
  - 자동 추천 확인, 수정, 확정
  - 축 A(필수 1개) + 축 B(기본 1개, 필요시 N개)
  - 규칙 학습(사용자 확정 결과 반영)
        |
        v
[원장(가계부) 레이어]
  - Firefly III (확정 거래만 반영)
        |
        v
[분석/재무관리 레이어]
  - Grafana 대시보드
  - 예산/목표 대비, 소비 습관 분석(교차축), 알림/리포트
```

### 2) 물리 아키텍처 (구성 컴포넌트)

* **Ingestion(수집)**

  * 스마트폰 자동화 앱(Tasker/MacroDroid 등) → Webhook/API 호출
  * CSV 업로드(은행/카드 내역)
  * 수동 입력(보조)

* **Orchestration/Automation**

  * n8n: 수집 이벤트 처리, 파싱/정규화 파이프라인 실행, 라우팅

* **Staging DB(임시 저장소)**

  * “원장 반영 전” 거래를 저장하는 표준 스키마
  * 분류 결과/검수 상태/수정 이력 유지

* **Ledger(원장)**

  * Firefly III + DB(MariaDB/MySQL/PostgreSQL 중 선택)
  * 확정된 거래만 기록하여 데이터 신뢰성 확보

* **Analytics**

  * Grafana + (필요 시) 별도 분석 DB/뷰
  * 카테고리×목적(교차축) 중심 분석 및 알림

### 3) 데이터/상태 설계 (강화 포인트)

#### 거래 상태 머신

* `INGESTED` : 수집됨
* `ENRICHED` : 정규화 완료(가맹점/계정 매핑)
* `CLASSIFIED` : 자동 분류 완료(추천 + confidence)
* `REVIEW_REQUIRED` : 검수 필요(신뢰도 낮음/충돌/신규 가맹점 등)
* `CONFIRMED` : 사용자 확정 완료
* `POSTED` : 원장 반영 완료
* `REJECTED` : 무시/중복/오탐

#### 2축 분류 데이터 모델(개념)

* Transaction(거래) 1개

  * Category(축 A) 1개 (필수, 회계/예산 기준)
  * Context(축 B) 1개 이상 (기본 1개 권장, 습관/목적 기준)

권장 정책:

* **축 A는 반드시 1개**(예산/정산 안정성)
* **축 B는 기본 1개**(교차 분석 깔끔)
  단, 실제 요구가 있으면 **복수 허용**(예: 교회+가족 같은 예외)

#### 원장 반영 매핑(권장)

* Firefly “Category” = 축 A(지출 성격)
* Firefly “Tags/Labels” = 축 B(목적/사용처)

이 방식으로 “식료품/교회”를 원장과 분석에서 모두 일관되게 유지한다.

---

## 구현방식

### 1) 운영 원칙

1. **원장(가계부)은 ‘확정된 거래만’ 기록**한다.
2. 자동 분류는 “정답”이 아니라 **추천+확률**을 제공한다.
3. 사용자가 웹에서 확정한 결과가 **분류 룰/사전(merchant dictionary)**에 누적되어 시간이 갈수록 자동 분류 정확도가 개선된다.
4. 분석/대시보드는 “카테고리 단독”이 아니라 **카테고리×목적(교차축)**을 기본 뷰로 제공한다.

---

### 2) 데이터 파이프라인(권장 시나리오)

#### (A) 실시간 흐름(소비 이벤트 발생)

1. 소비 이벤트 수집 (SMS 등)
2. n8n이 Webhook으로 이벤트 수신
3. Staging DB에 거래 저장(`INGESTED`)
4. 정규화 처리(`ENRICHED`)
5. 2축 자동 분류 실행(`CLASSIFIED`)
6. confidence 기준으로:

   * 높음: `CLASSIFIED`로 대기(자동 확정 옵션 가능)
   * 낮음/불확실: `REVIEW_REQUIRED`
7. 웹 검수 UI에서 사용자가 축 A/B 확정(`CONFIRMED`)
8. 확정된 거래만 Firefly III로 전송 후 `POSTED`

#### (B) 배치 흐름(CSV/내역 업로드)

* 업로드 시점에 동일 파이프라인을 배치로 실행하고,
* 검수 큐를 생성해 웹에서 일괄 처리한다.

---

### 3) 웹 검수/분류 UX 요구사항(필수)

* “검수 필요(REVIEW_REQUIRED)” 큐 제공
* 거래 상세에서:

  * 축 A 카테고리(필수) 선택
  * 축 B 목적/사용처(기본 1개, 필요 시 복수) 선택
  * 추천값(Top3) + confidence 표시
  * “추천대로 확정” / “수정 후 확정” 버튼
* 대량 처리:

  * 동일 가맹점(merchant_norm_id) 묶음 처리(일괄 분류)
  * 최근 N건 빠른 확정

---

### 4) 분류 체계(Taxonomy) 운영 방식(유연성)

* 축 A(카테고리)는 비교적 안정적인 “회계 분류”
* 축 B(목적/사용처)는 유연하게 늘어날 수 있는 “운영 분류”

  * 예: 교회/개인/가족/업무/모임/프로젝트 등
* 축 B는 사용자 정의가 쉬워야 하며,

  * 신규 목적 생성
  * 목적 병합/명칭 변경
  * 목적별 예산/목표 설정
    이 가능해야 한다.

---

### 5) 분석/재무관리(대시보드) 기본 요구사항

필수 대시보드 뷰:

1. 월간 요약: 수입/지출/순저축/저축률
2. 축 A 기준: 카테고리별 지출 Top N, 예산 대비 사용률
3. 축 B 기준: 목적/사용처별 지출 Top N, 예산 대비 사용률
4. **축 A × 축 B 매트릭스**

   * 예: 식료품×교회, 식료품×개인 등 교차 분석
5. 트렌드/습관:

   * 요일/시간대 소비 패턴
   * 반복 가맹점/구독성 지출
   * 전월 대비 급증 카테고리/목적

---

### 6) 보안/신뢰성(권장)

* 수집 API는 인증(토큰/서명) 필수
* 중복 방지 키(idempotency key)로 동일 거래 중복 입력 차단
* 수정 이력(누가/언제/무엇을) 기록
* 원장 반영은 `CONFIRMED` 상태만 허용

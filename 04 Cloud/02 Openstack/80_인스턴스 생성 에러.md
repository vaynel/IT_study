## 🛠 OpenStack 홈서버 구축 및 네트워크 장애 복구 보고서

### 1. 개요 (Background)

* **환경**: 단일 NIC(1개 랜카드) 홈서버, 공유기 환경(192.168.35.x 대역).
* **OS/배포**: Rocky Linux, Kolla-Ansible 기반 멀티노드 구성(Controller/Compute 분리).
* **장애 상황**: 인스턴스 생성 시 `MaxRetriesExceeded` 발생, 유동 IP(Floating IP) 할당 실패, 외부 SSH 접속 불가 현상.

---

### 2. 분석 내용 (Analysis & Root Cause)

#### ① 포트 바인딩 실패 (Port Binding Failed)

* **원인**: Neutron OVS 에이전트의 물리 네트워크 매핑(`bridge_mappings`) 누락. [cite: 2026-02-16]
* **상세**: 외부 네트워크는 `physnet1`이라는 이름표를 쓰도록 설정되었으나, 컴퓨트 노드는 이 이름표가 어느 브릿지(`br-ex`)와 연결되는지 알지 못해 가상 포트 생성을 거부함.

#### ② 설정 배포 불일치 (Config Sync Issue)

* **원인**: `globals.yml`에 설정을 추가했음에도 컴퓨트 노드에 반영되지 않음. [cite: 2026-02-16]
* **상세**: Ansible 인벤토리 변수 우선순위 혹은 노드 간 통신 문제로 인해 컨트롤러 노드에만 설정이 적용되고, 실제 VM이 구동되는 컴퓨트 노드에는 값이 전달되지 않음.

#### ③ 외부망 도달 불가능 (External Network Unreachable)

* **원인**: 가상 라우터(Router) 및 외부 게이트웨이 설정 누락.
* **상세**: 유동 IP는 NAT 기반으로 동작하므로, 프라이빗 네트워크와 외부 네트워크를 잇는 라우터가 없으면 IP 할당 자체가 불가능함(404 에러).

---

### 3. 해결 방안 (Final Solutions)

#### ✅ 네트워크 통로 확보 (Bridge Mapping 강제 주입)

* **방법**: 컴퓨트 노드 에이전트 설정 파일에 물리 네트워크 매핑 정보를 직접 주입.
* **조치**: `/etc/kolla/neutron-openvswitch-agent/openvswitch_agent.ini`에 `bridge_mappings = physnet1:br-ex` 추가 후 컨테이너 재시작.

#### ✅ 유동 IP 아키텍처 구성

* **방법**: 인스턴스를 직접 외부망(Flat)에 붙이지 않고, 라우터를 통한 Floating IP 방식으로 전환.
* **조치**: 라우터 생성 → 외부 게이트웨이 설정 → 내부 서브넷 연결 → 유동 IP 할당 순으로 작업 완료.

#### ✅ 보안 및 인스턴스 초기화 (Cloud-init)

* **방법**: SSH 접속을 위해 보안 그룹을 조정하고, `cloud-init`을 통해 초기 비밀번호 설정.
* **조치**: `Ingress` 규칙에 TCP 22번 및 ICMP(Ping) 추가, `cloud-config` 스크립트를 사용하여 Rocky Linux 유저 생성 및 패스워드 인증 활성화.

---

### 4. 필요한 학습 사항 (Further Learning)

1. **Neutron ML2/OVS 아키텍처**:
* `br-int`, `br-ex`, `br-tun` 각 브릿지의 역할과 이들이 패킷을 어떻게 주고받는지 이해가 필요합니다. [cite: 2026-02-16]


2. **L3 Agent & Floating IP 동작 원리**:
* 네트워크 네임스페이스(Namespace) 내에서 1:1 NAT가 일어나는 과정과 왜 VM 내부에서는 유동 IP가 보이지 않는지 학습하면 네트워크 장애 대응 능력이 향상됩니다.


3. **Kolla-Ansible 변수 우선순위**:
* `globals.yml`, `group_vars`, `host_vars`, 그리고 `/etc/kolla/config/` 하위의 커스텀 설정 파일 중 어떤 것이 우선 적용되는지 구조를 파악하면 배포 오류를 줄일 수 있습니다.


4. **Cloud-init 및 Metadata 서비스**:
* 인스턴스가 부팅될 때 메타데이터 서버(169.254.169.254)로부터 설정을 가져오는 과정과, 네트워크 불통 시 `cloud-init`이 실패하는 인과관계를 이해해야 합니다.

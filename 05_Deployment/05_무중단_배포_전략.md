# 무중단 배포 전략

---

## 무중단 배포란?

> **무중단 배포(Zero-Downtime Deployment)**는 서비스를 중단하지 않고 새로운 버전의 애플리케이션을 배포하는 방법입니다. 사용자는 배포 과정에서도 서비스를 계속 이용할 수 있어 서비스 가용성이 유지됩니다.

---

## 무중단 배포의 필요성

* **서비스 가용성 보장**: 사용자 경험 저하 방지
* **비즈니스 연속성**: 24/7 서비스 제공
* **점진적 배포**: 문제 발생 시 빠른 롤백 가능
* **리스크 최소화**: 전체 사용자에게 영향 전파 전 문제 발견

---

## 주요 무중단 배포 전략

### 1. Blue-Green 배포

#### 개념

동일한 환경을 두 개 구성(Blue: 기존, Green: 신규)하고, 전환 시점에 트래픽을 한 번에 스위칭하는 방식입니다.

#### 작동 방식

1. **Blue 환경** (현재 프로덕션): 현재 사용 중인 버전
2. **Green 환경** (신규 버전): 새 버전을 미리 준비
3. **검증**: Green 환경에서 충분한 테스트 수행
4. **전환**: 로드 밸런서를 Blue → Green으로 전환
5. **롤백**: 문제 발생 시 Blue로 즉시 전환

#### 장점

* **빠른 전환**: 즉시 신규 버전으로 전환 가능
* **즉시 롤백**: 문제 시 즉시 이전 버전으로 복귀
* **검증 용이**: 전환 전 새 버전 충분히 테스트 가능
* **단순한 구조**: 이해하기 쉬운 배포 방식

#### 단점

* **리소스 비용**: 두 환경 모두 운영 상태 유지 필요
* **데이터 동기화**: 데이터베이스 공유 시 마이그레이션 고려 필요
* **인프라 복잡도**: 동일한 환경 두 세트 관리 필요

#### 사용 사례

* 중요 서비스의 메이저 버전 업데이트
* 즉각적인 롤백이 필요한 경우
* 리소스 여유가 있는 환경

#### 구현 예시

```bash
# Docker Compose 예시
# blue-green-switch.sh

# Green 환경 시작
docker-compose -f docker-compose.green.yml up -d

# Health check 대기
sleep 30

# 로드 밸런서 설정 변경 (Nginx)
nginx -s reload

# Blue 환경 중지 (선택사항)
docker-compose -f docker-compose.blue.yml down
```

---

### 2. Canary 배포

#### 개념

신규 버전을 소수의 사용자나 서버에 먼저 배포하고, 점진적으로 비율을 늘려가는 방식입니다.

#### 작동 방식

1. **초기 배포**: 전체 트래픽의 5-10%만 신규 버전으로 라우팅
2. **모니터링**: 에러율, 응답 시간, 비즈니스 메트릭 확인
3. **점진적 확대**: 문제 없으면 25% → 50% → 100%로 확대
4. **롤백 또는 완료**: 문제 발생 시 롤백, 정상이면 완료

#### 장점

* **위험 최소화**: 문제가 소수 사용자에게만 영향
* **실제 환경 테스트**: 실제 트래픽으로 검증 가능
* **리소스 효율적**: 전체 환경을 두 개 구성할 필요 없음
* **점진적 적용**: 서비스 안정성 확인하며 확대

#### 단점

* **복잡한 라우팅**: 트래픽 분산 로직 필요
* **모니터링 필수**: 세밀한 모니터링 시스템 필요
* **시간 소요**: 점진적 확대로 인한 배포 시간 증가
* **데이터 일관성**: 두 버전이 동시 실행되므로 주의 필요

#### 사용 사례

* 대규모 프로덕션 환경
* 사용자 경험에 민감한 서비스
* 새로운 기능의 안정성 검증이 필요한 경우

#### 구현 예시

```yaml
# Kubernetes 예시
# canary-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: app-canary
spec:
  replicas: 2  # 전체의 10% (총 20개 중 2개)
  selector:
    matchLabels:
      app: my-app
      version: canary
  template:
    metadata:
      labels:
        app: my-app
        version: canary
    spec:
      containers:
      - name: app
        image: my-app:v2.0.0
---
# Service가 특정 비율로 트래픽 분산
# Istio 같은 서비스 메시 사용 시 더 세밀한 제어 가능
```

---

### 3. Rolling 배포

#### 개념

기존 인스턴스를 하나씩 순차적으로 새로운 버전으로 교체하는 방식입니다.

#### 작동 방식

1. **새 인스턴스 시작**: 기존 인스턴스 유지한 채 새 인스턴스 배포
2. **Health Check**: 새 인스턴스가 정상 동작하는지 확인
3. **트래픽 전환**: 새 인스턴스로 트래픽 라우팅 시작
4. **기존 인스턴스 종료**: 기존 인스턴스 중지 및 제거
5. **반복**: 모든 인스턴스가 새 버전으로 교체될 때까지 반복

#### 장점

* **리소스 효율적**: 동시에 두 환경 모두 운영할 필요 없음
* **점진적 업데이트**: 한 번에 하나씩 교체로 위험 분산
* **자동화 용이**: Kubernetes 등에서 기본 지원
* **롤백 용이**: 중간에 중단하고 이전 버전으로 복귀 가능

#### 단점

* **버전 혼재**: 업데이트 중 기존/신규 버전이 동시 실행
* **롤백 시간**: 전체 인스턴스 교체에 시간 소요
* **호환성 주의**: 기존/신규 버전 간 호환성 확보 필요

#### 사용 사례

* 컨테이너 기반 애플리케이션 (Docker, Kubernetes)
* 마이크로서비스 아키텍처
* 자동 스케일링이 필요한 환경

#### 구현 예시

```yaml
# Kubernetes Rolling Update (기본 전략)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-app
spec:
  replicas: 5
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1        # 동시에 추가 가능한 Pod 수
      maxUnavailable: 0  # 동시에 사용 불가능한 Pod 수 (0 = 무중단)
  template:
    spec:
      containers:
      - name: app
        image: my-app:v2.0.0
```

```bash
# Rolling 배포 실행
kubectl set image deployment/my-app app=my-app:v2.0.0

# 배포 상태 확인
kubectl rollout status deployment/my-app

# 롤백
kubectl rollout undo deployment/my-app
```

---

### 4. A/B 테스트 배포

#### 개념

두 버전을 동시에 운영하면서 사용자를 무작위 또는 특정 기준으로 분할하여 각각 다른 버전을 사용하도록 하는 방식입니다.

#### 작동 방식

1. **버전 준비**: A 버전(기존)과 B 버전(신규) 모두 운영
2. **사용자 분할**: 사용자 ID, 지역, 디바이스 등 기준으로 분할
3. **트래픽 분산**: 50:50 또는 원하는 비율로 트래픽 분산
4. **성과 비교**: 메트릭 수집 및 분석
5. **결정**: 우수한 버전 선택하여 전체 적용

#### Canary와의 차이점

* **Canary**: 위험 최소화를 위한 점진적 확대
* **A/B 테스트**: 기능 비교를 위한 동시 운영

#### 장점

* **데이터 기반 결정**: 실제 사용자 데이터로 비교
* **비즈니스 메트릭 측정**: 전환율, 매출 등 측정 가능
* **사용자 그룹별 테스트**: 타겟 그룹별 효과 측정

#### 단점

* **두 버전 동시 운영**: 리소스 사용량 증가
* **복잡한 분석**: 통계적으로 유의미한 결과 도출 필요
* **장기 운영**: 충분한 데이터 수집을 위한 시간 필요

#### 사용 사례

* 새로운 UI/UX 테스트
* 알고리즘 성능 비교
* 비즈니스 로직 변경 효과 측정

---

### 5. Recreate 배포

#### 개념

기존 버전을 완전히 중지한 후 새 버전을 배포하는 방식입니다. (무중단 배포가 아님)

#### 작동 방식

1. **기존 버전 중지**: 모든 인스턴스 중지
2. **새 버전 배포**: 새 버전의 인스턴스 시작
3. **서비스 재개**: 새 버전이 준비되면 서비스 재개

#### 특징

* **다운타임 발생**: 배포 중 서비스 중단
* **간단한 구조**: 가장 단순한 배포 방식
* **빠른 배포**: 전체 교체가 빠름

#### 사용 사례

* 개발/테스트 환경
* 다운타임이 허용되는 서비스
* 데이터베이스 마이그레이션이 필요한 경우

---

## 배포 전략 비교

| 전략 | 다운타임 | 리소스 사용 | 복잡도 | 롤백 속도 | 위험도 |
| ---- | -------- | ----------- | ------ | --------- | ------ |
| **Blue-Green** | 없음 | 높음 | 낮음 | 매우 빠름 | 낮음 |
| **Canary** | 없음 | 보통 | 높음 | 빠름 | 매우 낮음 |
| **Rolling** | 없음 | 낮음 | 중간 | 보통 | 보통 |
| **A/B 테스트** | 없음 | 높음 | 매우 높음 | 보통 | 낮음 |
| **Recreate** | 있음 | 낮음 | 매우 낮음 | 보통 | 높음 |

---

## 배포 전략 선택 가이드

### 리소스 여유가 있는 경우
→ **Blue-Green 배포**: 빠른 전환과 즉시 롤백이 필요한 경우

### 위험 최소화가 최우선인 경우
→ **Canary 배포**: 점진적 확대로 문제 조기 발견

### 리소스가 제한적인 경우
→ **Rolling 배포**: 효율적이며 무중단 배포 가능

### 기능 비교가 필요한 경우
→ **A/B 테스트**: 데이터 기반 의사결정 필요 시

### 간단하고 다운타임 허용 시
→ **Recreate 배포**: 개발 환경 또는 중단 허용 서비스

---

## 무중단 배포 구현 시 고려사항

### 1. Health Check

* 애플리케이션이 정상 동작하는지 확인하는 메커니즘
* Liveness Probe: 애플리케이션이 살아있는지 확인
* Readiness Probe: 트래픽을 받을 준비가 되었는지 확인

### 2. Graceful Shutdown

* 진행 중인 요청을 완료한 후 종료
* 새 요청 수신 중지 → 기존 요청 완료 대기 → 종료

### 3. 데이터베이스 마이그레이션

* 백워드 호환 가능한 변경 우선
* 점진적 마이그레이션 (Dual Write)
* 롤백 가능한 마이그레이션 전략

### 4. 세션 관리

* 세션 저장소 외부화 (Redis 등)
* Sticky Session 사용 시 주의 필요

### 5. 모니터링 및 알림

* 실시간 메트릭 모니터링
* 에러율, 응답 시간 추적
* 자동 롤백 트리거 설정

---

## 실제 구현 예시

### Nginx를 이용한 Blue-Green 전환

```nginx
# nginx.conf
upstream backend {
    # Blue-Green 전환 시 이 부분만 수정
    server blue.example.com:8080;  # 또는 green.example.com:8080
}
```

### Kubernetes Rolling Update 설정

```yaml
spec:
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0  # 무중단 보장
```

### Docker Compose를 이용한 Blue-Green

```yaml
# docker-compose.blue.yml
services:
  app:
    image: my-app:v1.0.0
    ports:
      - "8081:8080"

# docker-compose.green.yml  
services:
  app:
    image: my-app:v2.0.0
    ports:
      - "8082:8080"
```

---

## 참고

* 무중단 배포는 단순히 기술만으로 해결되지 않습니다
* 애플리케이션 설계 단계부터 고려해야 합니다
* 데이터베이스 스키마 변경은 별도 전략이 필요합니다
* 충분한 테스트와 모니터링이 필수입니다

